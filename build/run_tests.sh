#!/bin/bash
set -ex

GO_TEST_OPTS=$1
OPUS_VERSION=$2
OPUS_SHA=$3
WHISPER_VERSION=$4
WHISPER_SHA=$5
ONNX_VERSION=$6
ONNX_SHA=$7

OPUS_INCLUDE_PATH="/tmp/opus-${OPUS_VERSION}/include"
WHISPER_INCLUDE_PATH="/tmp/whisper.cpp-${WHISPER_VERSION}"
OPUS_LIBRARY_PATH="/tmp/opus-${OPUS_VERSION}/.libs"
WHISPER_LIBRARY_PATH=${WHISPER_INCLUDE_PATH}
ONNX_INCLUDE_PATH="/tmp/onnxruntime-linux-x64-${ONNX_VERSION}/include"
ONNX_LIBRARY_PATH="/tmp/onnxruntime-linux-x64-${ONNX_VERSION}/lib"

bash ./build/prepare_deps.sh ${OPUS_VERSION} ${OPUS_SHA} ${WHISPER_VERSION} ${WHISPER_SHA} "tiny" ${ONNX_VERSION} ${ONNX_SHA} && \
cp ./models/silero_vad.onnx /tmp/whisper.cpp-${WHISPER_VERSION}/models && \
MODELS_DIR=/tmp/whisper.cpp-${WHISPER_VERSION}/models \
C_INCLUDE_PATH="${OPUS_INCLUDE_PATH}:${WHISPER_INCLUDE_PATH}:${ONNX_INCLUDE_PATH}" \
LIBRARY_PATH="${OPUS_LIBRARY_PATH}:${WHISPER_LIBRARY_PATH}:${ONNX_LIBRARY_PATH}" \
LD_RUN_PATH="${ONNX_LIBRARY_PATH}" \
go test ${GO_TEST_OPTS} ./...
